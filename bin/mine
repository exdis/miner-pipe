#!/usr/bin/env node
import path from 'path';
import cli from 'clap';
import { createMinePipeline } from '../lib/pipeline.js';

var command = cli.create('mine')
    .option('-p, --provider <provider>', 'Provider')
    .option('--params <params>', 'Params')
    .option('-m, --miner <path>', 'Path to miner')
    .action(async function(args) {
        let params;

        try {
            params = JSON.parse(this.values.params);
        } catch (_) {}

        const pipeline = await createMinePipeline({
            provider: this.values.provider,
            miner: this.values.miner
        });
        console.log(await pipeline(params));
    });

try {
    command.run();
} catch (e) {
    // output user frendly message if cli error
    if (e instanceof cli.Error) {
        console.error(e.message || e);
        process.exit(2);
    }

    // otherwise re-throw exception
    throw e;
}
